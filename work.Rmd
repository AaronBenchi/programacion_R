---
title:    "**Trabajo Final**"
subtitle: "**Programación en R**"
author:   "**por [Aaron Pérez](https://www.linkedin.com/in/aaronbp/)**"
mail:     "aaronbenchiheubperez@gmail.com"
linkedin: "aaronbp"
twitter:  "bp_aaron"
github:   "AaronBenchi"
date:     "**`r Sys.Date()`**"
#logo:     ""
license:  by-nc-sa
urlcolor: blue
css: mi_diseño/mi_styles.css
output:
  html_document: 
    theme:        cosmo # "default", "cerulean", "journal", "flatly", "readable", "spacelab", "united", "cosmo", "lumen", "paper", "sandstone", "simplex", "yeti"
    highlight:    tango # "default", "tango", "pygments", "kate", "monochrome", "espresso", "zenburn", "haddock", "textmate"
    toc:          true
    toc_float:    true
    code_folding: show
    includes:
      after_body: mi_diseño/footer.html
  word_document:  default
  epuRate::epurate:
    toc:             TRUE
    number_sections: FALSE
    code_folding:    "show"
  pdf_document:   default
editor_options: 
  chunk_output_type: console
---

```{r setup, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      warning =FALSE, 
                      error = FALSE,
                      message = FALSE,
                      fig.align = "center", 
                      out.width = "100%")
```

```{r, include=FALSE}
# Para obligar a que salgan los iconos en documentos Rmarkdown
htmltools::tagList(rmarkdown::html_dependency_font_awesome())
```

![](mi_disen%CC%83o/Logo_AA.png){style="position:absolute;top:0px;right:0px;" width="108"}

## Cargar librerías, funciones, datos {.tabset}

Con esta línea de código cargamos todas las librerías, funciones y datos necesarios para esta práctica.

### Cargar función

```{r}
source("funciones.R")
```

### Ver función

```{r results="hide"}
# Función para cargar e instalar librerías
cargar_librerias <- function(librerias) {
  sapply(librerias, function(lib) {
    
    # Cargar la librería, y si no existe instalar y cargar.
    if(!require(lib, character.only = TRUE)) {
      
      # Instalar paquete
      install.packages(lib)
      
      # Cargar librería
      library(lib, character.only = TRUE)
    }
  })}

librerias <- c(
  'data.table',
  'tidyverse',
  'lubridate',
  'reactable')

cargar_librerias(librerias)
```

## Leer archivos {.tabset}

Leemos todos los archivos contenidos en el directorio **data** y el resultado es una la lista con todos nuestros dataframes.

### Cargar función

```{r}
fun_leer_archivos("data")
```

### Ver función

```{r results="hide"}
# Adquisición y preparación del dato

fun_leer_archivos <- function(carpeta_datos){

  # Leer archivos de el directorio data
  mis_tablas <<- list.files(carpeta_datos)
  
  # Nombre de las tablas sin el csv
  nombre_tablas <<- gsub(".csv", "", mis_tablas)
  
  # Número de tablas
  n_archivos <<- length(mis_tablas)
  
  # Ruta del completa de cada archivo
  mis_tablas_path <<- paste0(getwd(), "/data/", list.files("data"))
  
  # creo una lista con totdas las tablas
  lista_de_tablas <<- lapply(mis_tablas_path, fread)
  
  # lista de tablas con nombre
  lista_de_tablas <<- magrittr::set_names(lista_de_tablas, nombre_tablas)

}
```

Extraemos de la lista todos los dataframes y los cargamos en el *Enviroment.*

Limpiamos todo el el entrono y nos quedamos únicamente con los datos que nos itersan.

```{r warning =FALSE, error = FALSE, message = FALSE, results = "hide"}
# Obtenmeos los dataframe en el Environment
for (i in names(lista_de_tablas)) {
  assign(paste0("df_", i), lista_de_tablas[[i]])
}

# Limpiar entorno
no_limpiar <- c(paste0("df_", nombre_tablas),'lista_de_tablas', 'fun_na_df', 'fun_na_lista')
rm(list = setdiff(ls(), no_limpiar));graphics.off();globalenv();cat("\014")
```

## Tratamiento NAs {.tabset}

Verificaremos que dataframes tienen NAs y los imputaremos a la media, y de nuevo limpiamos el entorno.

### Cargar función

```{r warning =FALSE, error = FALSE, message = FALSE}
# Comprobamos los dataframe con NA ----
dataframes_NA <- fun_na_lista(lista_de_tablas)
dataframes_NA
```

```{r warning =FALSE, error = FALSE, message = FALSE, results = "hide"}
# Imputar los NA a la media en el dataframe df_PF_tv
df_PF_tv <- df_PF_tv %>% replace_na( list(
    tv_inversion = mean(na.omit(df_PF_tv$tv_inversion)) # imputar a la media
  ))

# Limpiar entorno ----
no_limpiar <- c("df_PF_rrss", "df_PF_sales", "df_PF_sem", "df_PF_tv")
rm(list = setdiff(ls(), no_limpiar));graphics.off();globalenv();cat("\014")
```

### Ver función

```{r}
# Funciones para localizar NA en dataframe y en lista

# Función encontrar Na en dataframe 
fun_na_df <- function(dataframe){
  sapply(dataframe, function(x) sum(is.na(dataframe)))
}

# Función encontrar Na en lista de dataframes
fun_na_lista <- function(lista_df){
  lista_df_NA <- lapply( X = lista_df , FUN = fun_na_df )
  return(lista_df_NA)
}
```

# Unión de dataframes

Uniremos los cuatro dataframes en un mismo dataframe, usando granularidad mensual y nos quedamos únicamente con el periodo de fechas coincidente.

## Tratamiento de variables para los 4 dataframes

1.  Damos formato a las fechas

2.  Ordenamos las fechas

3.  Pasamos de semenas a meses, agrupamos por meses el **df_PF_rrss** y **df_PF_sem**

```{r}
df_PF_rrss <- df_PF_rrss %>% 
  mutate(semana = as.Date(semana, format="%d/%m/%Y")) %>% 
  arrange(semana) %>% 
  mutate(mes = floor_date(semana, unit='month')) %>% 
  group_by(mes) %>%
  summarise(rrss_impresiones = sum(rrss_impresiones), 
            rrss_inversion = sum(rrss_inversion))

df_PF_sales <- df_PF_sales %>% 
  mutate(mes = as.Date(mes, format="%d/%m/%Y")) %>% 
  arrange(mes) 

df_PF_sem <- df_PF_sem %>% 
  mutate(semana = as.Date(semana, format="%d/%m/%Y")) %>% 
  arrange(semana) %>% 
  mutate(mes = floor_date(semana, unit='month')) %>% 
  group_by(mes) %>%
  summarise(sem_clicks = sum(sem_clicks), 
            sem_inversion = sum(sem_inversion))

df_PF_tv <- df_PF_tv %>% 
  mutate(mes = as.Date(mes, format="%d/%m/%Y")) %>% 
  arrange(mes)
```

## Comprobamos fechas de los dataframes

```{r}
# Comprobamos el rango de fechas de los dataframes
data.frame(
  dataframe = c("df_PF_rrss", "df_PF_sales", "df_PF_sem", "df_PF_tv"),
  fecha_minima = c(min(df_PF_rrss$mes),
                   min(df_PF_sales$mes),
                   min(df_PF_sem$mes),
                   min(df_PF_tv$mes)),
  fecha_máxima = c(max(df_PF_rrss$mes),
                   max(df_PF_sales$mes),
                   max(df_PF_sem$mes),
                   max(df_PF_tv$mes))
) %>% reactable()
```

## Unimos todos los dataframes

```{r}
df <- df_PF_rrss %>% 
  inner_join(df_PF_sales, by = "mes") %>% 
  inner_join(df_PF_sem, by = "mes") %>% 
  inner_join(df_PF_tv, by = "mes")
```

El resultado lo podemos ver en esta tabla **interactiva**:

```{r echo=FALSE}

mi_tabla <- reactable(
  df %>% 
  mutate_if(is.numeric, as.integer), # Mis datos
  pagination = T,
  fullWidth = T, # Tabla estrecha
  compact = TRUE, # Para estrecha los margenes laterales
  class = "followers-tbl",
  
  defaultColDef = colDef(
    headerStyle = list(
      left = 0, fontSize = 12,
      background = "#f0f0f0"
    )
    , align = "left"
  ),
  
  
  # Listado de columnas
  columns = list(
   
  # Columna 1
    mes = colDef(
      name = "Mes",
      align = "left",
      style = list(fontFamily = "monospace", whiteSpace = "pre")
    ),
    
   # Columna 2
    rrss_impresiones = colDef(
      name = "RRSS Impresiones",
      align = "left",
      style = list(fontFamily = "monospace", whiteSpace = "pre")
    ),
   
   # Columna 3
    rrss_inversion = colDef(
      name = "RRSS Inversión",
      align = "left",
      style = list(fontFamily = "monospace", whiteSpace = "pre")
    ),
   
   # Columna 4
    sales = colDef(
      name = "Ventas",
      align = "left",
      style = list(fontFamily = "monospace", whiteSpace = "pre")
    ),
   
   # Columna 5
    sem_clicks = colDef(
      name = "Clicks SEM",
      align = "left",
      style = list(fontFamily = "monospace", whiteSpace = "pre")
    ),
   
   # Columna 6
    sem_inversion = colDef(
      name = "SEM Inversión",
      align = "left",
      style = list(fontFamily = "monospace", whiteSpace = "pre")
    ),
   
   # Columna 7
    tv_inversion = colDef(
      name = "TV Inversión",
      align = "left",
      style = list(fontFamily = "monospace", whiteSpace = "pre")
    )
   
   

)
)


# Añadir titulo, subtitulo y centrado
htmltools::div(
  class = ".contenido_tabla_ancho_completo",
  htmltools::div(
    class = "header",
    htmltools::div(class = "title", "Tabla interactiva de medios"),
    paste0("Impresiones | Ventas | Clicks")
  ),
  mi_tabla
)

```

## Comprobamos las fechas en el nuevo df

```{r warning =FALSE, error = FALSE, message = FALSE, results = "hide"}
data.frame(
  dataframe = "df",
  fecha_minima = min(df$mes),
  fecha_máxima = max(df$mes)
) %>% reactable()

# Limpiar entorno ----
no_limpiar <- "df"
rm(list = setdiff(ls(), no_limpiar));graphics.off();globalenv();cat("\014")
```

